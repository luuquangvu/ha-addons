name: Auto bump Home Assistant add-ons on upstream :latest

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  check-bump-push:
    name: Bump ${{ matrix.addon.name }}
    concurrency:
      group: auto-bump-${{ matrix.addon.name }}
      cancel-in-progress: false
    strategy:
      matrix:
        addon:
          - name: gemini-fastapi
            dir: gemini-fastapi
            dockerfile: gemini-fastapi/Dockerfile
            digest_file: .github/upstream-gemini-fastapi.digest
    runs-on: ubuntu-latest
    env:
      ADDON_DIR: ${{ matrix.addon.dir }}
      DOCKERFILE: ${{ matrix.addon.dockerfile }}
      DIGEST_FILE: ${{ matrix.addon.digest_file }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq
          python -m pip install --upgrade pip PyYAML

      - name: Extract upstream ref from Dockerfile
        id: ref
        run: |
          REF=$(awk '/^FROM[[:space:]]+/ {print $2; exit}' "${DOCKERFILE}")
          if [ -z "$REF" ]; then
            echo "Cannot find FROM line in ${DOCKERFILE}" >&2
            exit 1
          fi
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "Upstream ref: $REF"

      - name: Resolve current digest of :latest
        id: latest
        run: |
          REF='${{ steps.ref.outputs.ref }}'
          INFO=$(skopeo inspect "docker://$REF")
          DIGEST=$(echo "$INFO" | jq -r '.Digest')
          if [ -z "$DIGEST" ] || [ "$DIGEST" = "null" ]; then
            echo "Failed to resolve digest for $REF" >&2
            exit 1
          fi
          echo "latest_digest=$DIGEST" >> "$GITHUB_OUTPUT"
          echo "Latest digest: $DIGEST"

      - name: Load previous seen digest (if any)
        id: prev
        run: |
          if [ -f "${DIGEST_FILE}" ]; then
            PREV=$(cat "${DIGEST_FILE}")
          else
            PREV=""
          fi
          echo "prev_digest=$PREV" >> "$GITHUB_OUTPUT"
          echo "Previous digest: ${PREV:-<none>}"

      - name: Stop if digest unchanged
        if: steps.prev.outputs.prev_digest == steps.latest.outputs.latest_digest
        run: |
          echo "Digest unchanged; nothing to do."
          exit 0

      - name: Read required architectures from add-on config
        if: steps.prev.outputs.prev_digest != steps.latest.outputs.latest_digest
        id: req
        run: |
          REQ=$(python - <<'PY'
          import os, pathlib, yaml
          addon_dir = pathlib.Path(os.environ["ADDON_DIR"])
          p = addon_dir / "config.yaml"
          data = yaml.safe_load(p.read_text(encoding="utf-8"))
          archs = data.get("arch") or []
          m = {
              "amd64":  "linux/amd64",
              "aarch64":"linux/arm64",
          }
          req = [m[a] for a in archs if a in m]
          print(" ".join(req))
          PY
          )
          echo "list=$REQ" >> "$GITHUB_OUTPUT"
          echo "Required platforms: $REQ"

      - name: Verify upstream provides all required architectures
        if: steps.prev.outputs.prev_digest != steps.latest.outputs.latest_digest
        run: |
          set -e
          REQ='${{ steps.req.outputs.list }}'
          REF='${{ steps.ref.outputs.ref }}'

          RAW=$(skopeo inspect --raw "docker://$REF")

          AVAIL=$(echo "$RAW" | jq -r '
            if has("manifests") then
              [ .manifests[].platform | "\(.os)/\(.architecture)" ] | unique | .[]
            else
              [ ( (.os // .Os // "linux") + "/" + (.architecture // .Architecture) ) ] | .[]
            end
          ')

          echo "Available platforms:"
          echo "$AVAIL" | sed 's/^/  - /'

          MISSING=0
          for r in $REQ; do
            echo "$AVAIL" | grep -qx "$r" || { echo "Missing required platform: $r"; MISSING=1; }
          done
          [ "$MISSING" -eq 0 ] || { echo "Upstream lacks required platforms; aborting bump."; exit 1; }

      - name: Bump version in config.yaml (patch +1) and update digest file
        if: steps.prev.outputs.prev_digest != steps.latest.outputs.latest_digest
        run: |
          set -e
          python - <<'PY'
          import os, pathlib, re, yaml
          addon_dir = pathlib.Path(os.environ["ADDON_DIR"])
          p = addon_dir / "config.yaml"
          data = yaml.safe_load(p.read_text(encoding="utf-8"))
          ver = str(data.get("version", "0.0.0"))
          m = re.match(r"^(\d+)\.(\d+)\.(\d+)$", ver)
          if not m:
            raise SystemExit(f"Unsupported version format in config.yaml: {ver}")
          a, b, c = map(int, m.groups())
          c += 1
          data["version"] = f"{a}.{b}.{c}"
          p.write_text(yaml.safe_dump(data, sort_keys=False, allow_unicode=True), encoding="utf-8")
          print("New version:", data["version"])
          PY

          mkdir -p "$(dirname "${DIGEST_FILE}")"
          echo '${{ steps.latest.outputs.latest_digest }}' > "${DIGEST_FILE}"

      - name: Lint Home Assistant add-on
        if: steps.prev.outputs.prev_digest != steps.latest.outputs.latest_digest
        uses: frenck/action-addon-linter@v2
        with:
          path: ${{ env.ADDON_DIR }}

      - name: Commit and push to main
        if: steps.prev.outputs.prev_digest != steps.latest.outputs.latest_digest
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${{ env.ADDON_DIR }}/config.yaml" "${{ env.DIGEST_FILE }}"
          git commit -m "chore(${{ matrix.addon.name }}): bump version (upstream ${{ steps.ref.outputs.ref }} -> ${{ steps.latest.outputs.latest_digest }})" || exit 0
          git push origin HEAD:main
